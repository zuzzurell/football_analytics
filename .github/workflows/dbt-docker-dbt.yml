name: DBT run new models in DOCKER

# Controls when the workflow will run
on:
  # Triggers the workflow on pull request events but only for the "main" branch
  pull_request:
    branches: [main]

env:
  DBT_PROFILES_DIR: ./profiles/
  DBT_ACCOUNT_FOOTBALL: ${{ secrets.DBT_ACCOUNT_FOOTBALL }}
  DBT_PASSWORD_FOOTBALL: ${{ secrets.DBT_PASSWORD_FOOTBALL }}
  DBT_COMMANDS: |
    dbt compile  # Compiles our feature branch changes
    dbt run --select "state:modified+" --profile dev --defer --state dbt-artifacts-files  # Runs modified dbt models only

jobs:
  # This workflow contains a single job called "build-dbt-modified"
  build-dbt-modified:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:

      # Checks out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Sets up Python
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      
      - name: Install Docker
        run: |
          python -m pip install --upgrade pip
          pip install docker

      - name: Build docker DBT image
        run: docker build . -t alessandro19920610/dbt-image
      
      - name: Download DBT artifacts
        id: download-artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: dbt-load-artifacts.yml 
          name: dbt-artifacts-files
          path: dbt-artifact-directory/
      
      - name: Display structure of downloaded files
        run: ls .

      - name: Copy artifacts to docker container
        run: |
          container_id=$(docker ps --latest -q)
          docker cp dbt-artifact-directory/. "${container_id}":/dbt_football_analytics/dbt-artifacts-files
          docker commit "${container_id}" alessandro19920610/dbt-image-artifacts

      
      - name: Docker Log IN
        run: docker login -u alessandro19920610 --p ${{ secrets.DBT_DOCKER }}

      - name: Push Image
        run: docker push alessandro19920610/dbt-image-artifacts

      - name: Pull Image
        run: docker pull alessandro19920610/dbt-image-artifacts

        
      - name: Run docker container
        run: |
          docker run \
            --env DBT_ACCOUNT_FOOTBALL="${DBT_ACCOUNT_FOOTBALL}" \
            --env DBT_PASSWORD_FOOTBALL="${DBT_PASSWORD_FOOTBALL}" \
            alessandro19920610/dbt-image-artifacts \
            /bin/bash -c "${DBT_COMMANDS}"
      



  deploy-to-development:
    needs: [build-dbt-modified]
    runs-on: ubuntu-latest
    environment: 
      name: development
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Sets up Python
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      
      - name: Install Docker
        run: |
          python -m pip install --upgrade pip
          pip install docker
      
      - name: Docker Log IN
        run: docker login -u alessandro19920610 --password-stdin <<<${{ secrets.DBT_DOCKER }}
      
      - name: Pull Docker Image with artifacts
        run: docker pull alessandro19920610/dbt-image-artifacts
      
      - name: New docker Image for development
        run: docker tag alessandro19920610/dbt-image alessandro19920610/dbt-image-development

      - name: Push Image
        run: docker push alessandro19920610/dbt-image-development
