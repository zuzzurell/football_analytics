name: DBT DOCKER CI BUILD IMAGE

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  pull_request:
    branches: [main]

  # Allows you to run this workflow manually from the Actions tab  
  workflow_dispatch:

env:
  DBT_PROFILES_DIR: ./profiles/
  DBT_ACCOUNT_FOOTBALL: ${{ secrets.DBT_ACCOUNT_FOOTBALL }}
  DBT_PASSWORD_FOOTBALL: ${{ secrets.DBT_PASSWORD_FOOTBALL }}
  DBT_COMMANDS:  dbt compile --profiles-dir profiles --profile dev --target-path=dbt-artifacts && ls

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

# This workflow contains a single job called "build-dbt"
  build-dbt-image:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:

      # Checks out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Sets up Python
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      
      - name: Install Docker
        run:  |
          python -m pip install --upgrade pip
          pip install docker
          
      - name: Build docker DBT image
        run: docker build . -t alessandro19920610/dbt-image
 
      - name: Run docker container
        run: |
          docker run \
            --env DBT_ACCOUNT_FOOTBALL="${DBT_ACCOUNT_FOOTBALL}" \
            --env DBT_PASSWORD_FOOTBALL="${DBT_PASSWORD_FOOTBALL}" \
            alessandro19920610/dbt-image \
            /bin/bash -c "${DBT_COMMANDS}"
      
      - name: Commit Changes to a New Image
        run: |
          container_id=$(docker ps --latest)
          docker commit "${container_id}" alessandro19920610/dbt-image
      
      - name: New docker Image with Aritifacts
        run: docker tag alessandro19920610/dbt-image alessandro19920610/dbt-image-artifacts

      - name: Docker Log IN
        run: docker login -u alessandro19920610 -p ${{ secrets.DBT_DOCKER }}
      
      - name: Push Image
        run: docker push alessandro19920610/dbt-image-artifacts

